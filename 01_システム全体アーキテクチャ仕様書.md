# システム全体アーキテクチャ仕様書
**トキワシティ訓練所**

---

## 1. アーキテクチャ概要

### 1.1 技術スタック
- **フロントエンド**: Next.js 14 (App Router)
- **ホスティング**: Vercel
- **バックエンド**: Vercel Functions (Edge Runtime + Node.js Runtime)
- **データベース**: Supabase (PostgreSQL)
- **リアルタイム**: Supabase Realtime
- **外部API**: PokeAPI
- **認証**: Supabase Auth (ゲスト認証 + 永続化)
- **状態管理**: Zustand + React Query
- **UI**: Tailwind CSS + shadcn/ui

### 1.2 システム構成図

```
┌─────────────────────────────────────┐
│           Frontend (Next.js)        │
│  ┌─────────────┐ ┌─────────────────┐ │
│  │   UI Layer   │ │  State Management│ │
│  │  (shadcn/ui) │ │    (Zustand)    │ │
│  └─────────────┘ └─────────────────┘ │
│  ┌─────────────────────────────────┐ │
│  │       Client Hooks Layer        │ │
│  │      (React Query + SWR)       │ │
│  └─────────────────────────────────┘ │
└─────────────────────────────────────┘
                    │
                    ↓ HTTPS
┌─────────────────────────────────────┐
│         Vercel Functions            │
│  ┌─────────────┐ ┌─────────────────┐ │
│  │ Edge Runtime│ │   Node Runtime  │ │
│  │ (Real-time) │ │ (Game Logic)    │ │
│  └─────────────┘ └─────────────────┘ │
└─────────────────────────────────────┘
                    │
                    ↓
┌─────────────────────────────────────┐
│            Supabase                 │
│  ┌─────────────┐ ┌─────────────────┐ │
│  │ PostgreSQL  │ │   Realtime      │ │
│  │ Database    │ │   Subscriptions │ │
│  └─────────────┘ └─────────────────┘ │
│  ┌─────────────────────────────────┐ │
│  │           Auth Layer            │ │
│  └─────────────────────────────────┘ │
└─────────────────────────────────────┘
                    │
                    ↓ HTTP Cache
┌─────────────────────────────────────┐
│              PokeAPI                │
│       (外部データソース)              │
└─────────────────────────────────────┐
```

---

## 2. コンポーネント詳細設計

### 2.1 フロントエンド層

#### 2.1.1 ページ構成
```
/                   - ダッシュボード (スクール概要)
/trainers           - トレーナー管理
/trainers/[id]      - 個別トレーナー詳細
/expeditions        - 派遣管理
/expeditions/[id]   - 個別派遣詳細
/facilities         - 施設管理
/pokemon            - ポケモン図鑑
/battles            - バトル履歴
/events             - イベント・大会
/settings           - 設定
```

#### 2.1.2 リアルタイム要件
- **派遣状況の更新**: 10分〜1時間に1回の状態変更
- **介入通知**: 重要な分岐点でのポップアップ
- **経済状況**: 収支の実時間更新
- **緊急イベント**: 怪我・発見等の即座通知

### 2.2 API層設計

#### 2.2.1 Vercel Functions構成
```
/api/
├── auth/                    # 認証関連
│   └── guest-login.js
├── game/                    # ゲームロジック
│   ├── simulation.js        # 派遣シミュレーション
│   ├── battle.js           # バトル判定
│   ├── intervention.js     # リアルタイム介入処理
│   └── economic.js         # 経済計算
├── pokemon/                # PokeAPI連携
│   ├── fetch.js           # PokeAPI データ取得
│   ├── cache.js           # キャッシュ管理
│   └── instances.js       # ポケモンインスタンス管理
├── realtime/               # リアルタイム処理
│   ├── events.js          # イベント配信
│   └── notifications.js   # 通知管理
└── admin/                  # 管理機能
    └── reset.js           # データリセット
```

#### 2.2.2 Edge Runtime vs Node.js Runtime
- **Edge Runtime**: リアルタイム通知、認証、軽量データ取得
- **Node.js Runtime**: 複雑なゲームロジック、大量データ処理、PokeAPI連携

### 2.3 データベース層

#### 2.3.1 Supabase設定
- **Row Level Security (RLS)**: ユーザーごとのデータ分離
- **Realtime**: 派遣状況、通知のリアルタイム更新
- **Functions**: 複雑なビジネスロジック（PostgreSQL Functions）
- **Triggers**: 自動計算・状態更新

---

## 3. セキュリティ・パフォーマンス設計

### 3.1 認証・認可
```typescript
// ゲスト認証 + 永続化
interface User {
  id: string;              // Supabase生成UUID
  guest_name: string;      // プレイヤー名
  school_name: string;     // スクール名
  created_at: timestamp;
  last_login: timestamp;
}
```

### 3.2 キャッシュ戦略
- **PokeAPI**: Redis Cache (7日間) + Supabase Table Cache
- **静的データ**: Next.js Static Generation
- **動的データ**: React Query (5分間)
- **リアルタイムデータ**: Supabase Realtime (即座更新)

### 3.3 パフォーマンス最適化
- **画像最適化**: Next.js Image + Vercel Image Optimization
- **バンドル最適化**: Dynamic Imports + Code Splitting
- **データベース**: インデックス最適化 + Connection Pooling
- **API レスポンス**: Gzip圧縮 + JSON最適化

---

## 4. スケーラビリティ・拡張性

### 4.1 将来拡張対応
- **多地方対応**: DB Schema の地方テーブル分離
- **マルチプレイヤー**: RLS + Realtime Channel 拡張
- **ファイル管理**: Supabase Storage (カスタム画像等)
- **API拡張**: Versioning + Backward Compatibility

### 4.2 モニタリング
- **Vercel Analytics**: パフォーマンス監視
- **Supabase Dashboard**: データベース監視
- **Error Tracking**: Vercel + Supabase Logs
- **ゲームメトリクス**: カスタムイベントトラッキング

### 4.3 デプロイメント戦略
- **ブランチ戦略**: main (production) / develop (staging)
- **環境分離**: Production / Preview / Development
- **データベース移行**: Supabase Migrations
- **CI/CD**: Vercel Git Integration + GitHub Actions

---

## 5. 開発フェーズ計画

### Phase 1: Core System (4-6週間)
- 基本認証・DB設計・API基盤
- トレーナー・ポケモン基本管理
- 簡易派遣システム

### Phase 2: Game Logic (6-8週間)
- 完全派遣システム・バトル判定
- 経済システム・施設管理
- PokeAPI完全統合

### Phase 3: Advanced Features (4-6週間)
- リアルタイム介入システム
- 職業システム・詳細バランス調整
- UI/UX最終調整

### Phase 4: Polish & Launch (2-4週間)
- パフォーマンス最適化
- バグ修正・テスト
- デプロイメント・監視設定

---

## 6. 技術的制約・考慮事項

### 6.1 Vercel制約
- **Function Timeout**: 60秒 (Pro Plan)
- **Memory Limit**: 1024MB
- **Cold Start**: Edge Runtime優先使用

### 6.2 Supabase制約  
- **Connection Limits**: 適切なプーリング設定
- **Realtime Limits**: チャンネル数・メッセージ頻度管理
- **Storage Limits**: 不要データの定期クリーンアップ

### 6.3 PokeAPI制約
- **Rate Limit**: 100req/min (キャッシュ必須)
- **データ整合性**: バージョン管理・定期同期
- **可用性**: フォールバック機構

---

## 7. 運用・保守

### 7.1 バックアップ戦略
- **データベース**: Supabase自動バックアップ + 手動エクスポート
- **設定ファイル**: Git管理 + Environment Variables

### 7.2 アップデート戦略
- **ゲームバランス**: JSON設定ファイル化
- **新機能**: Feature Flag + Gradual Rollout
- **データ移行**: Backward Compatible Migrations

### 7.3 サポート体制
- **ログ管理**: 構造化ログ + 検索可能
- **エラー追跡**: Error Boundary + Stack Trace
- **ユーザーサポート**: FAQ + Issue Template