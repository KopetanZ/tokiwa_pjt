# データベース設計仕様書
**トキワシティ訓練所**

---

## 1. データベース概要

### 1.1 使用技術
- **RDBMS**: PostgreSQL (Supabase)
- **ORM**: Supabase Client + TypeScript
- **レプリケーション**: Supabase Realtime
- **セキュリティ**: Row Level Security (RLS)

### 1.2 設計原則
- **正規化**: 第3正規形を基本とし、パフォーマンス要件に応じて非正規化
- **拡張性**: 他地方・新機能追加に対応可能な設計
- **レトロUI対応**: ドット絵アセット管理に特化した設計
- **リアルタイム**: 派遣・介入システムに最適化

---

## 2. メインテーブル設計

### 2.1 ユーザー管理

#### users
```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  guest_name VARCHAR(50) NOT NULL,
  school_name VARCHAR(100) NOT NULL,
  current_money INTEGER DEFAULT 50000,
  total_reputation INTEGER DEFAULT 0,
  ui_theme VARCHAR(20) DEFAULT 'retro_red', -- レトロテーマ設定
  settings JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- RLS Policy
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can only access their own data" ON users
  FOR ALL USING (id = auth.uid());
```

### 2.2 トレーナー管理

#### trainer_jobs (職業定義)
```sql
CREATE TABLE trainer_jobs (
  id SERIAL PRIMARY KEY,
  job_name VARCHAR(50) UNIQUE NOT NULL,
  job_name_ja VARCHAR(50) NOT NULL,
  description TEXT,
  max_level INTEGER DEFAULT 10,
  specializations JSONB NOT NULL, -- {capture: 1.2, battle: 0.9, exploration: 1.1}
  unlock_cost INTEGER DEFAULT 0,
  sprite_path VARCHAR(200), -- ドット絵スプライトパス
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 初期データ例
INSERT INTO trainer_jobs (job_name, job_name_ja, specializations, sprite_path) VALUES
('ranger', 'レンジャー', '{"capture": 1.25, "exploration": 1.15, "battle": 0.95}', '/sprites/jobs/ranger.png'),
('breeder', 'ブリーダー', '{"breeding": 1.30, "healing": 1.20, "capture": 1.05}', '/sprites/jobs/breeder.png'),
('battler', 'バトラー', '{"battle": 1.25, "strategy": 1.15, "capture": 0.90}', '/sprites/jobs/battler.png');
```

#### trainers
```sql
CREATE TABLE trainers (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  name VARCHAR(50) NOT NULL,
  job_id INTEGER REFERENCES trainer_jobs(id),
  job_level INTEGER DEFAULT 1,
  job_experience INTEGER DEFAULT 0,
  
  -- 基礎ステータス (企画書の嗜好システム)
  preferences JSONB NOT NULL DEFAULT '{}', -- バイアス値 (-50~+50)
  compliance_rate INTEGER DEFAULT 50, -- 遵守率 (0-100)
  trust_level INTEGER DEFAULT 0, -- 信頼度 (0-100)
  personality VARCHAR(50) DEFAULT 'balanced',
  
  -- 派遣状態
  status VARCHAR(20) DEFAULT 'available', -- available, on_expedition, injured, training
  current_expedition_id UUID REFERENCES expeditions(id),
  
  -- 経済
  salary INTEGER NOT NULL DEFAULT 3000,
  total_earned INTEGER DEFAULT 0,
  
  -- アセット
  sprite_path VARCHAR(200), -- カスタムスプライト
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_trainers_user_id ON trainers(user_id);
CREATE INDEX idx_trainers_status ON trainers(status);
```

### 2.3 ポケモン管理

#### pokemon_species (PokeAPI同期データ)
```sql
CREATE TABLE pokemon_species (
  id INTEGER PRIMARY KEY, -- PokeAPI ID
  name VARCHAR(50) NOT NULL,
  name_ja VARCHAR(50),
  types TEXT[] NOT NULL, -- [fire, flying]
  base_stats JSONB NOT NULL, -- {hp: 78, attack: 84, defense: 78, ...}
  height INTEGER,
  weight INTEGER,
  catch_rate INTEGER DEFAULT 45,
  rarity_tier INTEGER DEFAULT 1, -- 1-5 (common to legendary)
  
  -- ドット絵アセット管理
  sprite_front VARCHAR(200), -- フロントスプライト
  sprite_back VARCHAR(200),  -- バックスプライト
  sprite_icon VARCHAR(200),  -- アイコン (16x16)
  sprite_retro VARCHAR(200), -- レトロ版 (初代風)
  
  -- メタデータ
  pokeapi_url VARCHAR(200),
  last_sync TIMESTAMPTZ DEFAULT NOW(),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_pokemon_species_types ON pokemon_species USING GIN(types);
CREATE INDEX idx_pokemon_species_rarity ON pokemon_species(rarity_tier);
```

#### pokemon_instances (個体管理)
```sql
CREATE TABLE pokemon_instances (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  species_id INTEGER REFERENCES pokemon_species(id),
  trainer_id UUID REFERENCES trainers(id) ON DELETE SET NULL,
  
  -- 個体情報
  nickname VARCHAR(50),
  level INTEGER DEFAULT 1,
  experience INTEGER DEFAULT 0,
  individual_values JSONB DEFAULT '{}', -- IV相当 {hp: 15, attack: 12, ...}
  
  -- 状態
  current_hp INTEGER,
  max_hp INTEGER,
  status_condition VARCHAR(20) DEFAULT 'healthy', -- healthy, poisoned, paralyzed, etc
  
  -- パーティ配置
  party_position INTEGER CHECK (party_position BETWEEN 1 AND 6),
  
  -- 習得技 (最大4つ)
  moves JSONB DEFAULT '[]', -- [{name: "tackle", pp: 35, type: "normal"}, ...]
  
  -- 捕獲・発見情報
  caught_at TIMESTAMPTZ DEFAULT NOW(),
  caught_location VARCHAR(100),
  caught_by_trainer UUID REFERENCES trainers(id),
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_pokemon_instances_user ON pokemon_instances(user_id);
CREATE INDEX idx_pokemon_instances_trainer ON pokemon_instances(trainer_id);
CREATE INDEX idx_pokemon_instances_party ON pokemon_instances(trainer_id, party_position);
```

### 2.4 派遣システム

#### expedition_locations (派遣先定義)
```sql
CREATE TABLE expedition_locations (
  id SERIAL PRIMARY KEY,
  location_name VARCHAR(100) NOT NULL,
  location_name_ja VARCHAR(100) NOT NULL,
  region VARCHAR(50) DEFAULT 'kanto',
  
  -- 距離・コスト
  distance_level INTEGER NOT NULL, -- 1-5 (近郊-遠方)
  travel_cost INTEGER NOT NULL,
  travel_time_hours INTEGER NOT NULL,
  risk_level DECIMAL(3,2) DEFAULT 1.0, -- 1.0 = 標準
  
  -- 報酬設定
  base_reward_money INTEGER DEFAULT 1000,
  reward_multiplier DECIMAL(3,2) DEFAULT 1.0,
  
  -- 出現ポケモン
  encounter_species INTEGER[] DEFAULT '{}', -- pokemon_species.id array
  encounter_rates JSONB DEFAULT '{}', -- {species_id: rate}
  
  -- アセット
  background_image VARCHAR(200), -- 背景画像 (ドット絵)
  map_icon VARCHAR(200), -- マップアイコン
  
  -- 解放条件
  unlock_requirements JSONB DEFAULT '{}',
  is_unlocked_by_default BOOLEAN DEFAULT false,
  
  created_at TIMESTAMPTZ DEFAULT NOW()
);

INSERT INTO expedition_locations (location_name, location_name_ja, distance_level, travel_cost, travel_time_hours) VALUES
('viridian_forest', 'トキワの森', 1, 500, 2),
('route_22', '22番道路', 1, 300, 1),
('pewter_gym', 'ニビジム', 2, 1200, 4),
('mt_moon', 'お月見山', 3, 2000, 8),
('cerulean_cave', 'ハナダの洞窟', 5, 5000, 24);
```

#### expeditions (派遣履歴・進行中)
```sql
CREATE TABLE expeditions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  trainer_id UUID REFERENCES trainers(id) ON DELETE CASCADE,
  location_id INTEGER REFERENCES expedition_locations(id),
  
  -- 派遣設定
  expedition_mode VARCHAR(20) DEFAULT 'balanced', -- exploration, safe, aggressive
  target_duration_hours INTEGER NOT NULL,
  advice_given JSONB DEFAULT '{}', -- プレイヤーアドバイス記録
  
  -- 進行状況
  status VARCHAR(20) DEFAULT 'preparing', -- preparing, active, intervention_required, completed, cancelled
  started_at TIMESTAMPTZ,
  expected_return TIMESTAMPTZ,
  actual_return TIMESTAMPTZ,
  current_progress DECIMAL(3,2) DEFAULT 0.0, -- 0.0-1.0
  
  -- 介入システム
  intervention_opportunities JSONB DEFAULT '[]', -- 介入可能なイベント
  intervention_responses JSONB DEFAULT '{}', -- プレイヤーの選択記録
  
  -- 結果
  result_summary JSONB DEFAULT '{}', -- {money: 1500, experience: 200, pokemon_caught: [1, 3], items: []}
  success_rate DECIMAL(3,2), -- 0.0-1.0
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_expeditions_user ON expeditions(user_id);
CREATE INDEX idx_expeditions_trainer ON expeditions(trainer_id);
CREATE INDEX idx_expeditions_status ON expeditions(status);
CREATE INDEX idx_expeditions_active ON expeditions(status) WHERE status = 'active';
```

### 2.5 施設管理

#### facilities
```sql
CREATE TABLE facilities (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  facility_type VARCHAR(50) NOT NULL, -- training_ground, library, medical_center, etc
  
  -- レベル・強化
  level INTEGER DEFAULT 1,
  max_level INTEGER DEFAULT 5,
  upgrade_cost INTEGER NOT NULL,
  
  -- 効果
  effects JSONB NOT NULL DEFAULT '{}', -- {training_speed: 1.15, injury_recovery: 1.2}
  
  -- 経済
  maintenance_cost INTEGER DEFAULT 0, -- 月次維持費
  construction_cost INTEGER NOT NULL,
  
  -- アセット
  sprite_path VARCHAR(200), -- 施設ドット絵
  
  -- 状態
  status VARCHAR(20) DEFAULT 'active', -- active, under_construction, disabled
  construction_started TIMESTAMPTZ,
  construction_completed TIMESTAMPTZ,
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_facilities_user ON facilities(user_id);
CREATE INDEX idx_facilities_type ON facilities(facility_type);
```

### 2.6 経済管理

#### economic_transactions
```sql
CREATE TABLE economic_transactions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  
  -- 取引情報
  transaction_type VARCHAR(30) NOT NULL, -- expedition_reward, salary_payment, facility_cost, etc
  amount INTEGER NOT NULL, -- 正数=収入, 負数=支出
  description TEXT,
  
  -- 関連エンティティ
  related_expedition_id UUID REFERENCES expeditions(id),
  related_trainer_id UUID REFERENCES trainers(id),
  related_facility_id UUID REFERENCES facilities(id),
  
  -- メタデータ
  balance_after INTEGER NOT NULL, -- 取引後残高
  transaction_date TIMESTAMPTZ DEFAULT NOW(),
  
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_transactions_user ON economic_transactions(user_id);
CREATE INDEX idx_transactions_type ON economic_transactions(transaction_type);
CREATE INDEX idx_transactions_date ON economic_transactions(transaction_date);
```

---

## 3. リアルタイム・イベント管理

### 3.1 介入システム

#### intervention_events
```sql
CREATE TABLE intervention_events (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  expedition_id UUID REFERENCES expeditions(id) ON DELETE CASCADE,
  
  -- イベント情報
  event_type VARCHAR(50) NOT NULL, -- rare_pokemon_found, danger_zone, trainer_injured, etc
  event_data JSONB NOT NULL, -- イベント固有データ
  
  -- 選択肢
  choices JSONB NOT NULL, -- [{id: 1, text: "捕獲を試みる", risk: "high", reward: "rare_pokemon"}]
  
  -- 状態
  status VARCHAR(20) DEFAULT 'pending', -- pending, responded, expired, auto_resolved
  player_choice INTEGER, -- 選択されたchoice.id
  response_deadline TIMESTAMPTZ NOT NULL,
  responded_at TIMESTAMPTZ,
  
  -- 結果
  outcome JSONB DEFAULT '{}', -- 選択の結果
  
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_intervention_events_expedition ON intervention_events(expedition_id);
CREATE INDEX idx_intervention_events_status ON intervention_events(status);
```

### 3.2 通知システム

#### notifications
```sql
CREATE TABLE notifications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  
  -- 通知内容
  notification_type VARCHAR(50) NOT NULL, -- expedition_complete, intervention_required, etc
  title VARCHAR(200) NOT NULL,
  message TEXT NOT NULL,
  
  -- 関連データ
  related_data JSONB DEFAULT '{}',
  action_url VARCHAR(200), -- クリック時の遷移先
  
  -- 状態
  is_read BOOLEAN DEFAULT false,
  priority VARCHAR(20) DEFAULT 'normal', -- low, normal, high, urgent
  
  -- 有効期限
  expires_at TIMESTAMPTZ,
  
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_notifications_user ON notifications(user_id);
CREATE INDEX idx_notifications_unread ON notifications(user_id, is_read) WHERE is_read = false;
```

---

## 4. ドット絵アセット管理

### 4.1 アセット管理テーブル

#### game_assets
```sql
CREATE TABLE game_assets (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  asset_type VARCHAR(50) NOT NULL, -- pokemon_sprite, trainer_sprite, facility_sprite, ui_element
  asset_category VARCHAR(50), -- front, back, icon, animation
  asset_name VARCHAR(100) NOT NULL,
  
  -- ファイル情報
  file_path VARCHAR(300) NOT NULL,
  file_size INTEGER,
  dimensions VARCHAR(20), -- "32x32", "64x64"
  format VARCHAR(10) DEFAULT 'png',
  
  -- メタデータ
  retro_style BOOLEAN DEFAULT true,
  generation VARCHAR(20) DEFAULT 'gen1', -- gen1, gen2, custom
  palette_type VARCHAR(50) DEFAULT 'gameboy', -- gameboy, gameboy_color, custom
  
  -- 関連エンティティ
  pokemon_species_id INTEGER REFERENCES pokemon_species(id),
  trainer_job_id INTEGER REFERENCES trainer_jobs(id),
  
  -- バージョン管理
  version INTEGER DEFAULT 1,
  is_active BOOLEAN DEFAULT true,
  
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_game_assets_type ON game_assets(asset_type);
CREATE INDEX idx_game_assets_pokemon ON game_assets(pokemon_species_id);
```

---

## 5. インデックス・パフォーマンス最適化

### 5.1 複合インデックス
```sql
-- 派遣関連の高速検索
CREATE INDEX idx_expeditions_user_status_date ON expeditions(user_id, status, created_at);

-- ポケモン検索最適化
CREATE INDEX idx_pokemon_instances_user_trainer_party ON pokemon_instances(user_id, trainer_id, party_position);

-- 経済履歴の高速集計
CREATE INDEX idx_transactions_user_type_date ON economic_transactions(user_id, transaction_type, transaction_date);

-- リアルタイム通知
CREATE INDEX idx_notifications_user_unread_priority ON notifications(user_id, is_read, priority, created_at);
```

### 5.2 パーティション戦略
```sql
-- 大量データ対応 (将来)
-- CREATE TABLE economic_transactions_y2024m01 PARTITION OF economic_transactions
-- FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');
```

---

## 6. セキュリティ・RLS設定

### 6.1 Row Level Security
```sql
-- 全テーブルでRLS有効化 & ユーザーデータ分離
CREATE POLICY "User isolation" ON trainers FOR ALL USING (user_id = auth.uid());
CREATE POLICY "User isolation" ON pokemon_instances FOR ALL USING (user_id = auth.uid());
CREATE POLICY "User isolation" ON expeditions FOR ALL USING (user_id = auth.uid());
CREATE POLICY "User isolation" ON facilities FOR ALL USING (user_id = auth.uid());
CREATE POLICY "User isolation" ON economic_transactions FOR ALL USING (user_id = auth.uid());
CREATE POLICY "User isolation" ON notifications FOR ALL USING (user_id = auth.uid());

-- 読み取り専用データは全ユーザーアクセス可能
CREATE POLICY "Public read" ON pokemon_species FOR SELECT USING (true);
CREATE POLICY "Public read" ON trainer_jobs FOR SELECT USING (true);
CREATE POLICY "Public read" ON expedition_locations FOR SELECT USING (true);
CREATE POLICY "Public read" ON game_assets FOR SELECT USING (true);
```

---

## 7. データ移行・初期化

### 7.1 マスターデータ初期化
```sql
-- トレーナー職業初期データ
INSERT INTO trainer_jobs (job_name, job_name_ja, specializations, sprite_path) VALUES
('ranger', 'レンジャー', '{"capture": 1.25, "exploration": 1.15}', '/sprites/jobs/ranger.png'),
('breeder', 'ブリーダー', '{"breeding": 1.30, "healing": 1.20}', '/sprites/jobs/breeder.png'),
('battler', 'バトラー', '{"battle": 1.25, "strategy": 1.15}', '/sprites/jobs/battler.png'),
('researcher', 'リサーチャー', '{"discovery": 1.25, "rare_find": 1.30}', '/sprites/jobs/researcher.png'),
('medic', 'メディック', '{"healing": 1.35, "safety": 1.25}', '/sprites/jobs/medic.png');
```

### 7.2 PokeAPI同期
```sql
-- PokeAPI同期用プロシージャ
CREATE OR REPLACE FUNCTION sync_pokemon_species(species_data JSONB) 
RETURNS void AS $$
BEGIN
  INSERT INTO pokemon_species (id, name, name_ja, types, base_stats, height, weight, catch_rate)
  VALUES (
    (species_data->>'id')::integer,
    species_data->>'name',
    species_data->'names'->0->>'name',
    array(select jsonb_array_elements_text(species_data->'types')),
    species_data->'stats',
    (species_data->>'height')::integer,
    (species_data->>'weight')::integer,
    (species_data->>'capture_rate')::integer
  )
  ON CONFLICT (id) DO UPDATE SET
    name_ja = EXCLUDED.name_ja,
    last_sync = NOW();
END;
$$ LANGUAGE plpgsql;